on:
  push:
    branches:
      - feature/*
      - bugfix/*
      - develop
      - release/*
      - hotfix/*
      - main
      - v5

jobs:
  # Note: changing the name of the job disables Slither checks with the error:
  # Warning: Code scanning cannot determine the alerts introduced by this pull
  # request, because 1 configuration present on refs/heads/develop was not found:
  #
  # Actions workflow (main.yml)
  # ‚ùì .github/workflows/main.yml:coverage
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Nodejs
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # Cache dependencies
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Check storage layout
        run: npm run test-storage-layout
      # TODO: Remove before merging to develop
      - name: Run test
        run: |
          npm run test \
            test/byContract/ENSIntegration/** \
            test/byContract/IexecAccessors/** \
            test/byContract/IexecCategoryManager/** \
            test/byContract/IexecERC20/** \
            test/byContract/IexecEscrow/** \
            test/byContract/IexecMaintenance/** \
            test/byContract/IexecOrderManagement/** \
            test/byContract/IexecRelay/** \
            test/byContract/IexecPoco/** \
            test/byContract/registries/** \
            test/*fullchain* && \
            npm run test:native
      - name: Run deployment
        # Basic deployment to make sure everything is ok.
        # Could be removed in the future if not relevant.
        run: npm run deploy
    #   TODO: Re-enable it before merging to develop
    #   - name: Test Timelock Deployment
    #     run: npm run deploy:timelock
    #   - name: Run coverage
    #     run: npm run coverage
    #   - name: Upload coverage reports to Codecov
    #     uses: codecov/codecov-action@v4.0.1
    #     with:
    #       token: ${{ secrets.CODECOV_TOKEN }}
    #       slug: iExecBlockchainComputing/PoCo
    #   - name: Run static analysis with Slither
    #     uses: crytic/slither-action@v0.4.0
    #     with:
    #       target: "contracts/tools/testing/slither/"
    #       solc-version: '0.8.21'
    #       slither-args: --checklist --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/
    #       fail-on: none # TODO set this to high or other
    #       sarif: results.sarif
    #   - name: Upload SARIF file
    #     uses: github/codeql-action/upload-sarif@v3
    #     with:
    #       sarif_file: results.sarif
